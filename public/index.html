<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Unhook</title>
  <link href="https://fonts.googleapis.com/css2?family=Hanken+Grotesk:wght@400;600;700&family=DM+Sans:wght@400;600;700&family=Poppins:wght@400;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    *{box-sizing:border-box;font-family:var(--app-font,"Hanken Grotesk"),system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    :root{
      --brand:#002293;--brand-dark:#001b75;--bg1:#f5faff;--bg2:#e3f3ff;--card:#fff;--ink:#0b1b33;--muted:#6b7a90;--ring:rgba(0,34,147,.18);
      --accent:#002293;
    }
    body[data-theme="ocean"]{--bg1:#e8f7ff;--bg2:#cfefff;--brand:#0066cc;--brand-dark:#004b99;--accent:#0066cc;}
    body[data-theme="sunset"]{--bg1:#fff2e8;--bg2:#ffe1cf;--brand:#ff7a59;--brand-dark:#d55c3e;--accent:#ff7a59;}
    body[data-theme="midnight"]{--bg1:#0e1220;--bg2:#0a0f1a;--card:#11162a;--ink:#dfe7ff;--muted:#9fb1ff;--brand:#5b7cff;--brand-dark:#3e5fe6;--accent:#5b7cff;}
    body[data-theme="sunny"]{--bg1:#fffddb;--bg2:#fff8c2;--brand:#ff9f43;--brand-dark:#d68233;--accent:#ff9f43;}
    body[data-theme="calm"]{--bg1:#f0fbf8;--bg2:#e3f6f1;--brand:#00a388;--brand-dark:#007f6c;--accent:#00a388;}
    body[data-theme="forest"]{--bg1:#f0fff0;--bg2:#e3ffe3;--brand:#4c8a4c;--brand-dark:#3a6e3a;--accent:#4c8a4c;}
    html,body{height:100%;margin:0;padding:0;}
    body{background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink)}
    header{background:var(--brand);color:#fff;padding:24px;font-size:28px;font-weight:700;text-align:center;}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .tabs{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:14px auto 8px;align-items:center}
    .tab{background:var(--brand);color:#fff;padding:12px 22px;border-radius:999px;cursor:pointer;font-weight:600;transition:.12s}
    .tab:hover{background:var(--brand-dark)}
    .pill{margin-left:auto;background:#eef3ff;color:#2746ff;padding:8px 14px;border-radius:999px;font-weight:700;box-shadow:0 2px 8px var(--ring);}
    .section{display:none}
    .section.active{display:block;animation:fade .3s ease}
    @keyframes fade{from{opacity:0;}to{opacity:1;}}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:860px){.grid-2{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 24px var(--ring);margin:14px 0}
    select,input,textarea{width:100%;padding:14px;border-radius:12px;border:1px solid #e7eef8;box-shadow:0 6px 14px rgba(0,0,0,.04)}
    .cta{background:var(--brand);color:#fff;border:0;padding:12px 20px;border-radius:999px;font-weight:700;cursor:pointer}
    .cta:hover{background:var(--brand-dark)}
    .cta.small{padding:8px 14px;font-size:14px}
    .cta.ghost{background:transparent;color:var(--brand);border:2px solid var(--brand)}
    .pfp-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(60px,1fr));
      gap:10px;margin-top:8px;
    }
    .pfp-choice{
      font-size:32px;
      padding:10px;
      cursor:pointer;
      background:var(--card);
      border:2px solid transparent;
      border-radius:14px;
      text-align:center;
      transition:.2s;
    }
    .pfp-choice.active{
      border-color:var(--brand);
      transform:scale(1.12);
    }
    .badge-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:12px;
    }
    .badge{
      text-align:center;
      padding:10px;
      border-radius:12px;
      background:var(--card);
      box-shadow:0 2px 8px var(--ring);
      font-size:14px;
    }
    .chat-box{
      height:380px;overflow:auto;border-radius:16px;
      background:var(--card);padding:12px;
      box-shadow:inset 0 0 0 1px #e9eef6,0 10px 24px var(--ring);
    }
    .msg small{color:var(--muted);font-weight:600;margin-right:6px}
    .pixel-pet-wrap{image-rendering:pixelated;transform:translateZ(0)}
    .pixel-pet{image-rendering:pixelated}
    .pixel-pet.small{image-rendering:pixelated}
    #onboardCard .cta{background:#ffd34e;color:#111}
    #onboardCard .cta.ghost{background:transparent;color:#ffd34e;border:2px solid #ffd34e}
    @keyframes petBob{0%{transform:translateY(0)}50%{transform:translateY(-2px)}100%{transform:translateY(0)}}
    .pixel-pet.small{animation:petBob 2s infinite}
    #petEmote{font-size:16px;line-height:1;padding:4px 8px;border-radius:8px;background:#222;color:#ffd34e;box-shadow:0 6px 14px rgba(0,0,0,.25);transform:translateY(4px);opacity:0;transition:opacity .18s,transform .18s}
    .space-between{display:flex;justify-content:space-between;align-items:center}
    .inline{display:flex;align-items:center;gap:8px}
    label{font-weight:600;margin-bottom:6px;display:block}
    textarea{min-height:100px;resize:vertical}
    .muted{color:var(--muted);font-size:14px}
    .center{text-align:center}
    .motivation-grid, #stickyGrid {
      display:grid;
      gap:14px;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      margin-top:12px;
    }
    .sticky {
      padding:14px;
      border-radius:10px;
      font-size:16px;
      box-shadow:0 6px 14px rgba(0,0,0,.08);
      font-family:"Playfair Display", serif;
      transition:transform .2s;
    }
    .sticky:hover { transform:scale(1.03); }
    .sticky.gentle {
      background:#fff8b8;
      border:1px solid #f4e48b;
    }
    .sticky.firey {
      background:#ffd2d2;
      border:1px solid #ffb2b2;
    }
    .sticky.mix {
      background:#c7e6ff;
      border:1px solid #9fdaff;
    }
    .profile-pic{
      width:120px;height:120px;border-radius:50%;
      object-fit:cover;box-shadow:0 4px 12px rgba(0,0,0,.15);
      margin-bottom:10px;
    }
    .stat-row{
      display:flex;justify-content:space-between;
      padding:4px 0;font-size:15px;
    }
    .chat-box {
      height: 380px;
      overflow-y: auto;
      padding: 12px;
      background: var(--card);
      border-radius: 14px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06), 0 10px 24px rgba(0,0,0,.04);
      margin-bottom: 14px;
    }
    .chat-msg {
      margin-bottom: 10px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .chat-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }
    .chat-bubble {
      padding: 10px 14px;
      border-radius: 14px;
      max-width: 80%;
      line-height: 1.35;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
    }
    .chat-me { background: #c7e6ff; border:1px solid #9fd3ff; margin-left:auto; }
    .chat-other { background: #fff9cc; border:1px solid #f5e6a5; }
    textarea#chatInput {
      height: 70px;
      resize: none;
    }
    .pixel-pet.idle rect[fill="#ffd34e"]{fill:#ffd34e}
    .pixel-pet.happy rect[fill="#ffd34e"]{fill:#ffee85}
    .pixel-pet.hurt rect[fill="#ffd34e"]{fill:#ff8c8c}
    .pixel-pet.sleep rect[fill="#ffd34e"]{fill:#e8d87c}
    .pixel-pet.happy rect[x="5"][y="11"]{fill:#ff4081}
    .pixel-pet.happy rect[x="9"][y="11"]{fill:#ff4081}
    .pixel-pet.hurt rect[x="5"][y="11"]{fill:#000}
    .pixel-pet.hurt rect[x="9"][y="11"]{fill:#000}
    .pixel-pet.sleep rect[x="5"][y="11"]{fill:#000}
    .pixel-pet.sleep rect[x="9"][y="11"]{fill:#000}
    .pixel-pet.small.happy{animation:pet-bounce .5s ease-in-out 2}
    @keyframes pet-bounce{0%{transform:translateY(0) scale(1)}50%{transform:translateY(-4px) scale(1.06)}100%{transform:translateY(0) scale(1)}}
    #toast {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      color:#fff;
      padding:10px 18px;
      font-size:14px;
      border-radius:20px;
      opacity:0;
      pointer-events:none;
      transition:opacity .3s ease;
      z-index:1500;
      box-shadow:0 6px 16px rgba(0,0,0,.2);
    }
    #toast.show {
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }
    .lds-dual-ring {
      display:inline-block;
      width:64px;
      height:64px;
    }
    .lds-dual-ring:after {
      content:" ";
      display:block;
      width:46px;
      height:46px;
      margin:1px;
      border-radius:50%;
      border:5px solid var(--accent);
      border-color:var(--accent) transparent var(--accent) transparent;
      animation:lds-dual-ring 1.2s linear infinite;
    }
    @keyframes lds-dual-ring {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
</head>
<body>
<header>Unhook: Breaking the Vape</header>
<div class="tabs wrap">
  <div class="tab" data-go="checkin">Check-In</div>
  <div class="tab" data-go="journal">Journal</div>
  <div class="tab" data-go="motivation">Motivation</div>
  <div class="tab" data-go="shop">Shop</div>
  <div class="tab" data-go="profile">Profile</div>
  <div class="tab" data-go="community">Community</div>
  <div class="pill right" id="coinPill">
    <svg class="pixel-pet small" viewBox="0 0 16 16" width="40" height="40">
        <rect x="4" y="2" width="8" height="8" fill="#ffd34e"/>
        <rect x="3" y="4" width="2" height="2" fill="#000"/>
        <rect x="11" y="4" width="2" height="2" fill="#000"/>
        <rect x="4" y="10" width="8" height="4" fill="#ffd34e"/>
        <rect x="5" y="11" width="2" height="2" fill="#000"/>
        <rect x="9" y="11" width="2" height="2" fill="#000"/>
    </svg>
    Coins: <span id="coinCount">0</span>
  </div>
</div>
<main class="wrap">
<div id="onboardOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1200;">
  <div id="onboardCard" style="width:min(520px,92vw);background:#111;color:#fff;border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.35);overflow:hidden;">
    <div style="padding:20px 20px 0;display:flex;gap:12px;align-items:center;justify-content:center;">
      <div class="pixel-pet-wrap">
        <svg class="pixel-pet" viewBox="0 0 16 16" width="120" height="120">
          <rect width="16" height="16" fill="#2b2b2b"/>
          <rect x="5" y="2" width="6" height="6" fill="#ffd34e"/>
          <rect x="4" y="4" width="2" height="2" fill="#000"/>
          <rect x="10" y="4" width="2" height="2" fill="#000"/>
          <rect x="7" y="6" width="2" height="1" fill="#000"/>
          <rect x="3" y="8" width="10" height="5" fill="#ffd34e"/>
          <rect x="2" y="10" width="12" height="3" fill="#ffb84e"/>
          <rect x="6" y="13" width="4" height="2" fill="#654321"/>
        </svg>
      </div>
    </div>
    <div id="onboardStep1" style="padding:14px 20px 0;text-align:center;">
      <h3 style="margin:0 0 6px;font-size:22px;">Welcome to Unhook 2.0</h3>
      <p style="margin:0 0 14px;opacity:.9;">Meet your pixel buddy. Level it up by staying vape-free and earning coins.</p>
      <button class="cta" id="obNext1" style="margin:10px auto 20px;display:inline-block;">Next</button>
    </div>
    <div id="onboardStep2" style="display:none;padding:0 20px 0 20px;">
      <label style="font-weight:700;display:block;margin:0 0 8px;">Name your buddy</label>
      <input id="petNameInput" type="text" placeholder="e.g., Pixel Puff" style="width:100%;padding:12px;border-radius:12px;border:1px solid #2a2f3e;background:#0d1120;color:#fff;">
      <div style="display:flex;justify-content:space-between;gap:10px;margin:16px 0 20px;">
        <button class="cta ghost" id="obBack2">Back</button>
        <button class="cta" id="obNext2">Next</button>
      </div>
    </div>
    <div id="onboardStep3" style="display:none;padding:0 20px 18px 20px;">
      <label style="font-weight:700;display:block;margin:0 0 8px;">Pick your starter vibe</label>
      <select id="starterStyle" style="width:100%;padding:12px;border-radius:12px;border:1px solid #2a2f3e;background:#0d1120;color:#fff;">
        <option value="gentle">Gentle</option>
        <option value="firey">Firey</option>
        <option value="mix" selected>Mix</option>
      </select>
      <div style="display:flex;justify-content:space-between;gap:10px;margin:16px 0 20px;">
        <button class="cta ghost" id="obBack3">Back</button>
        <button class="cta" id="obFinish">Start</button>
      </div>
    </div>
  </div>
</div>
<div id="petHud" style="position:fixed;right:14px;bottom:14px;z-index:1100;display:none;">
  <div style="background:#111;color:#fff;border-radius:14px;padding:10px 12px;box-shadow:0 12px 28px rgba(0,0,0,.35);display:flex;align-items:center;gap:10px;">
    <div style="position:relative;">
        <div id="petEmote" style="position:absolute;top:-20px;left:50%;transform:translate(-50%, 4px);z-index:10;font-size:16px;line-height:1;padding:4px 8px;border-radius:8px;background:#222;color:#ffd34e;box-shadow:0 6px 14px rgba(0,0,0,.25);opacity:0;transition:opacity .18s,transform .18s">⭐</div>
        <svg class="pixel-pet small" viewBox="0 0 16 16" width="40" height="40" style="margin-right:8px;vertical-align:middle;transform-origin:50% 100%;">
          <rect width="16" height="16" fill="#2b2b2b"/>
          <rect x="5" y="2" width="6" height="6" fill="#ffd34e"/>
          <rect x="4" y="4" width="2" height="2" fill="#000"/>
          <rect x="10" y="4" width="2" height="2" fill="#000"/>
          <rect x="7" y="6" width="2" height="1" fill="#000"/>
          <rect x="3" y="8" width="10" height="5" fill="#ffd34e"/>
          <rect x="2" y="10" width="12" height="3" fill="#ffb84e"/>
          <rect x="6" y="13" width="4" height="2" fill="#654321"/>
        </svg>
    </div>
    <div>
      <div id="petHudName" style="font-weight:800;letter-spacing:.2px;">Buddy</div>
      <div style="width:140px;height:8px;background:#2a2f3e;border-radius:999px;overflow:hidden;">
        <div id="petXpBar" style="height:100%;width:0;background:linear-gradient(90deg,#ffd34e,#ff9f43);"></div>
      </div>
      <div id="petLevelTxt" style="font-size:12px;opacity:.8;margin-top:2px;">Lv.1 • 0/100xp</div>
    </div>
  </div>
</div>
<section id="checkin" class="section active">
  <h2 class="section-title">Daily Check-In</h2>
  <div class="grid-2">
    <div class="card">
      <label>How are you feeling today?</label>
      <select id="moodSel">
        <option value="5">Excellent</option>
        <option value="4" selected>Good</option>
        <option value="3">Okay</option>
        <option value="2">Not great</option>
        <option value="1">Rough</option>
      </select>
    </div>
    <div class="card">
      <label>Did you experience cravings today?</label>
      <select id="craveSel">
        <option value="none" selected>No cravings</option>
        <option value="mild">Mild</option>
        <option value="strong">Strong</option>
      </select>
    </div>
  </div>
  <div class="grid-2">
    <div class="card">
      <label>What triggered your cravings?</label>
      <input id="triggerTxt" type="text" placeholder="stress, boredom, etc"/>
    </div>
    <div class="card">
      <label>Did you vape today?</label>
      <select id="vapedSel">
        <option value="no" selected>No</option>
        <option value="yes">Yes</option>
      </select>
    </div>
  </div>
  <div class="card">
    <label>Notes</label>
    <textarea id="notesTxt" placeholder="Anything else?"></textarea>
    <div style="display:flex;justify-content:space-between;margin-top:10px;">
      <button class="cta small ghost" id="clearDraftBtn">Clear</button>
      <button class="cta" id="saveCheckinBtn">Save Check-In</button>
    </div>
    <p id="checkinMsg" class="muted" style="text-align:center;margin-top:6px;"></p>
  </div>
</section>
<section id="journal" class="section">
  <h2 class="section-title">Journal</h2>
  <div class="card">
    <div class="space-between">
      <strong>Prompt</strong>
      <div class="inline">
        <button id="prevPrompt" class="cta small ghost" type="button">• Prev</button>
        <button id="nextPrompt" class="cta small" type="button">Next •</button>
      </div>
    </div>
    <p id="promptText" style="margin:10px 0 0;"></p>
  </div>
  <div class="card">
    <div class="space-between">
      <label style="margin:0">Your entry</label>
      <label class="inline" style="margin:0">
        <input type="checkbox" id="freeWriteToggle"/>
        <span class="muted">Free write (ignore prompt)</span>
      </label>
    </div>
    <textarea id="journalEntry" placeholder="Write what's on your mind…"></textarea>
    <div class="space-between" style="margin-top:10px;">
      <button class="cta small ghost" id="clearJournalDraft">Clear</button>
      <div class="inline">
        <button class="cta" id="saveJournalBtn">Save Entry (+7 coins)</button>
        <span class="muted" id="saveJournalMsg"></span>
      </div>
    </div>
  </div>
  <div class="card" id="journalHistoryCard" style="display:none;">
    <strong>Previous prompts</strong>
    <ul id="journalHistory" class="muted" style="margin:8px 0 0; padding-left:18px;"></ul>
  </div>
</section>
<section id="motivation" class="section">
  <h2 class="section-title">Motivation</h2>
  <div class="card">
    <div class="space-between">
      <strong>Choose your vibe</strong>
      <div class="inline">
        <select id="motivationStyle">
        <option value="gentle">Gentle</option>
        <option value="firey">Firey</option>
        <option value="mix" selected>Mix</option>
</select>
        <div style="width:12px;"></div>
        <div id="motivationCount" class="muted">0 stickies found</div>
        <div style="width:12px;"></div>
        <button id="saveStyleBtn" class="cta small">Save</button>
      </div>
    </div>
  </div>
  <div id="motivationGrid" class="motivation-grid">
    <div id="stickyGrid"></div> 
  </div>
</section>
<section id="shop" class="section">
  <h2 class="section-title">Rewards Shop</h2>
  <div class="card">
    <p class="muted">Earn coins by journaling, checking in, and staying vape-free. Use them to unlock themes and badges!</p>
  </div>
  <h3>Themes</h3>
  <div class="badge-grid">
    <div class="themeCard card" data-theme="sunny">
      <strong>Sunny</strong><br>
      <span class="muted">Cost: 25 coins</span><br>
      <button class="cta small buy-theme" data-cost="25" data-theme="sunny">Unlock</button>
    </div>
    <div class="themeCard card" data-theme="calm">
      <strong>Calm</strong><br>
      <span class="muted">Cost: 30 coins</span><br>
      <button class="cta small buy-theme" data-cost="30" data-theme="calm">Unlock</button>
    </div>
    <div class="themeCard card" data-theme="forest">
      <strong>Forest</strong><br>
      <span class="muted">Cost: 40 coins</span><br>
      <button class="cta small buy-theme" data-cost="40" data-theme="forest">Unlock</button>
    </div>
  </div>
  <h3 style="margin-top:20px;">Badges</h3>
  <div class="badge-grid">
    <div class="card">
      <strong>Day 1 Badge 🎉</strong><br>
      <span class="muted">Cost: 10 coins</span><br>
      <button class="cta small buy-badge" data-cost="10" data-badge="day1">Unlock</button>
    </div>
    <div class="card">
      <strong>1-Week Badge 🏅</strong><br>
      <span class="muted">Cost: 40 coins</span><br>
      <button class="cta small buy-badge" data-cost="40" data-badge="week">Unlock</button>
    </div>
    <div class="card">
      <strong>1-Month Badge 🏆</strong><br>
      <span class="muted">Cost: 100 coins</span><br>
      <button class="cta small buy-badge" data-cost="100" data-badge="month">Unlock</button>
    </div>
  </div>
  <p id="shopMsg" class="muted" style="margin-top:10px;text-align:center;"></p>
</section>
<section id="profile" class="section">
  <h2 class="section-title">Your Profile</h2>
  <div class="card center">
    <img id="profilePic" class="profile-pic" src="https://i.imgur.com/8Km9tLL.png" alt="Profile Picture">
    <input type="file" id="uploadPicInput" accept="image/*" style="display:none;">
    <button class="cta small" id="uploadPicBtn">Change Photo</button>
  </div>
  <div class="card">
    <div class="stat-row">
      <span>Current Streak:</span> 
      <strong><span id="streakCount">0</span> days 🔥</strong>
    </div>
    <div class="stat-row">
      <span>Total Check-Ins:</span> 
      <strong><span id="checkinCount">0</span></strong>
    </div>
    <div class="stat-row">
      <span>Total Journal Entries:</span> 
      <strong><span id="journalCount">0</span></strong>
    </div>
  </div>
  <div class="card">
    <strong>Theme</strong>
    <select id="themeSelect" style="margin-top:6px;">
      <option value="default">Default</option>
      <option value="sunny">Sunny</option>
      <option value="calm">Calm</option>
      <option value="forest">Forest</option>
    </select>
    <button class="cta small" id="applyThemeBtn" style="margin-top:8px;">Apply Theme</button>
    <p class="muted" id="themeMsg" style="margin-top:6px;"></p>
  </div>
  <button class="cta ghost" id="logoutBtn" style="width:100%;margin-top:16px;">Log Out</button>
</section>

<section id="community" class="section">
  <h2 class="section-title">Community Chat</h2>
  <div class="card">
    <p class="muted">You're not alone - support others and stay motivated together!</p>
  </div>
  <div id="chatBox" class="chat-box"></div>
  <div class="card" style="margin-top:12px;">
    <textarea id="chatInput" placeholder="Type a supportive message..."></textarea>
    <div class="space-between" style="margin-top:8px;">
      <button id="sendChatBtn" class="cta">Send</button>
      <span class="muted" id="chatMsg"></span>
    </div>
  </div>
</section>
</main>
<canvas id="confettiCanvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999;"></canvas>
<div id="toast"></div>
<div id="rewardPop" style="
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-size:40px;
  font-weight:900;
  opacity:0;
  pointer-events:none;
  z-index:1000;
"></div>
<div id="loadingOverlay" style="
  display:none;
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,.7);
  backdrop-filter:blur(4px);
  z-index:1000;
  align-items:center;
  justify-content:center;">
  <div class="lds-dual-ring"></div>
</div>
<input type="hidden" id="currentUserId">
<input type="hidden" id="unlockedThemes">
<input type="hidden" id="ownedBadges">
<input type="hidden" id="dailyStreakCount">
<input type="hidden" id="internalCoinStore">
<input type="hidden" id="storedProfilePic">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { 
  getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
  signInAnonymously, signOut
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { 
  getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, addDoc 
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { 
  getStorage, ref, uploadBytes, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";
const firebaseConfig = {
  apiKey: "AIzaSyAhsjCfr7B-9vxxcA9bnLr46VcxbRMftvA",
  authDomain: "unhook-38abb.firebaseapp.com",
  projectId: "unhook-38abb",
  storageBucket: "unhook-38abb.appspot.com",
  messagingSenderId: "463077981870",
  appId: "1:463077981870:web:0a31c274187a8ad102e553"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();
const storage = getStorage();
const coinCountEl = document.getElementById("coinCount");
const streakCountEl = document.getElementById("streakCount");
const userLevelEl = document.getElementById("userLevel");
const userAvatarEl = document.getElementById("userAvatar");
let currentUserId = "";
let coins = 0;
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click",()=>{
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    document.getElementById(t.dataset.go).classList.add("active");
    if (t.dataset.go === 'motivation') {
      renderStickies();
    }
  });
});
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    clearTimeout(toast.timer);
    toast.timer = setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}
const storeNum={
    get:(k,d=0)=>{const v=localStorage.getItem(k);const n=Number(v);return Number.isFinite(n)?n:d},
    set:(k,n)=>localStorage.setItem(k,String(n))
};
const COIN_KEY="coins_v2";
function getLocalCoins(){return storeNum.get(COIN_KEY,0)}
function updateCoinDisplays(){
  coinCountEl.textContent = coins;
}
window.addCoins=async function(delta){
  bloop(920,0.06);
  coins = Math.max(0, coins + (Number(delta) || 0));
  updateCoinDisplays();
  await updateDoc(doc(db,"users",currentUserId),{coins});
  try{
    const pet=document.querySelector(".pixel-pet.small");
    if(pet){pet.classList.add("happy");setTimeout(()=>pet.classList.remove("happy"),600)}
    gsap.fromTo("#coinPill",{scale:1},{scale:1.12,duration:.18,yoyo:true,repeat:1});
  }catch(_){}
  await grantXP(delta * 5);
}
async function grantXP(x){
  if(!currentUserId)return;
  const r=doc(db,"users",currentUserId);
  const s=await getDoc(r);
  let d=s.data()||{};
  let lvl=d.petLevel||1;
  let xp=d.petXP||0;
  const beforeLvl = lvl;
  xp+=Math.max(0,Math.floor(x));
  while(xp>=100){xp-=100;lvl++}
  await updateDoc(r,{petXP:xp,petLevel:lvl});
  showHud({petName:d.petName||"Buddy",petStyle:d.petStyle||"mix",petLevel:lvl,petXP:xp})
  const afterLvl = lvl;
  if(afterLvl > beforeLvl) {
    petCheer();
  } else {
    petHappy();
  }
}
const STICKIES={
  gentle:["You’ve already proven you can do hard things.","Slip-ups don’t erase progress. They teach you.","Breathe. This urge will pass.","Talk to yourself like you would to a best friend.","Tiny wins today become big wins later.","Every check-in is proof you care.","One day at a time beats all-or-nothing."],
  firey:["Wanting and doing are different. Do it.","Cravings last minutes. Pride lasts longer.","You’re in charge, not the vape.","If it costs your health, it’s too expensive.","Future you is begging you to keep going.","Replace the habit: move, sip water, breathe.","You’re stronger than this moment."],
  mix:["Reset is always one choice away.","Every check-in is proof you care.","One day at a time beats all-or-nothing.","Replace the habit: move, sip water, breathe.","You’re stronger than this moment.","Cravings last minutes. Pride lasts longer.","Talk to yourself like you would to a best friend."]
};
function renderStickies(){
  const grid=document.getElementById('stickyGrid');
  const style=(localStorage.getItem('motivation_style')||'"mix"').replace(/^"+|"+$/g,'');
  const list=[...(STICKIES[style]||STICKIES.mix)];
  grid.innerHTML='';
  list.forEach(txt=>{
    const d=document.createElement('div');
    d.className='sticky '+(style==='firey'?'firey':style==='gentle'?'gentle':'mix');
    d.textContent=txt;
    grid.appendChild(d);
    try{gsap.fromTo(d,{y:8,opacity:0},{y:0,opacity:1,duration:.22,ease:'power1.out'})}catch(_){}
  });
  document.getElementById("motivationCount").textContent = `${list.length} stickies found`;
}
document.getElementById('saveStyleBtn').addEventListener('click',()=>{
  const style=document.getElementById('motivationStyle').value;
  localStorage.setItem('motivation_style',JSON.stringify(style));
  renderStickies();
  showToast("Motivation style saved!");
});
document.getElementById("motivationStyle").onchange = renderStickies;
(function initMotivationUI(){
  const saved=(localStorage.getItem('motivation_style')||'"mix"').replace(/^"+|"+$/g,'');
  document.getElementById('motivationStyle').value=saved;
  renderStickies();
})();
async function deductCoins(cost){
  if(coins < cost){
    showToast("Not enough coins!");
    return false;
  }
  coins -= cost;
  coinCountEl.textContent = coins;
  await updateDoc(doc(db,"users",currentUserId),{coins});
  return true;
}
document.querySelectorAll(".buy-theme").forEach(btn=>{
  btn.onclick = async()=>{
    let cost = +btn.dataset.cost;
    let theme = btn.dataset.theme;
    if(localStorage.getItem(`theme_${theme}`)) { showToast(`You already own the ${theme} theme!`); return; }
    if(await deductCoins(cost)){
      localStorage.setItem(`theme_${theme}`,true);
      showToast(`Unlocked ${theme} theme!`);
    }
  }
});
document.querySelectorAll(".buy-badge").forEach(btn=>{
  btn.onclick = async()=>{
    let cost = +btn.dataset.cost;
    let badge = btn.dataset.badge;
    if(localStorage.getItem(`badge_${badge}`)) { showToast(`You already own the ${badge} badge!`); return; }
    if(await deductCoins(cost)){
      localStorage.setItem(`badge_${badge}`,true);
      showToast("Badge unlocked 🏆");
    }
  }
});
const themeSelect = document.getElementById("themeSelect");
document.getElementById("applyThemeBtn").onclick = ()=>{
  let val = themeSelect.value;
  if(val!=="default" && !localStorage.getItem(`theme_${val}`)){
    showToast("Unlock this theme first");
    return;
  }
  document.body.setAttribute("data-theme",val);
  localStorage.setItem("activeTheme",val);
  showToast("Theme applied!");
};
let savedTheme = localStorage.getItem("activeTheme");
if(savedTheme) document.body.setAttribute("data-theme",savedTheme);
document.querySelectorAll("button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    btn.style.transform="scale(.94)";
    setTimeout(()=>btn.style.transform="scale(1)",140);
  });
});
function coinPop(amount){
  let el=document.getElementById("rewardPop");
  el.style.opacity=1;
  el.textContent = `+${amount} 🪙`;
  el.style.transform="translate(-50%,-50%) scale(1.5)";
  setTimeout(()=>{
    el.style.opacity=0;
    el.style.transform="translate(-50%,-50%) scale(1)";
  },700);
}
const ob=document.getElementById("onboardOverlay"),s1=document.getElementById("onboardStep1"),s2=document.getElementById("onboardStep2"),s3=document.getElementById("onboardStep3"),ob1=document.getElementById("obNext1"),obb2=document.getElementById("obBack2"),ob2=document.getElementById("obNext2"),obb3=document.getElementById("obBack3"),obf=document.getElementById("obFinish"),petNameInput=document.getElementById("petNameInput"),starterStyle=document.getElementById("starterStyle"),petHud=document.getElementById("petHud"),petHudName=document.getElementById("petHudName"),petXpBar=document.getElementById("petXpBar"),petLevelTxt=document.getElementById("petLevelTxt");
function bloop(f=700,t=0.08){
  try{
    const a=new (window.AudioContext||window.webkitAudioContext)();
    const o=a.createOscillator();const g=a.createGain();
    o.type="square";o.frequency.value=f;g.gain.value=.06;
    o.connect(g);g.connect(a.destination);
    o.start();
    setTimeout(()=>{o.stop();a.close()},t*1000)
  }catch(e){}
}
function step(show){
  s1.style.display=show===1?"block":"none";
  s2.style.display=show===2?"block":"none";
  s3.style.display=show===3?"block":"none"
}
ob1.onclick=()=>{bloop(820);step(2)};
obb2.onclick=()=>{bloop(620);step(1)};
ob2.onclick=()=>{
  if(!petNameInput.value.trim()){bloop(320);petNameInput.focus();return}
  bloop(880);step(3)
};
obb3.onclick=()=>{bloop(620);step(2)};
obf.onclick=async()=>{
  bloop(980);
  const name=petNameInput.value.trim()||"Buddy";
  const style=starterStyle.value;
  await ensureUserDoc();
  await updateDoc(doc(db,"users",currentUserId),{onboardingDone:true,petName:name,petStyle:style,petLevel:1,petXP:0});
  localStorage.setItem("pet.onboard","1");
  ob.style.display="none";
  showHud({petName:name,petStyle:style,petLevel:1,petXP:0});
  showToast("Onboarding complete! Welcome!");
};
function showHud(d){
  petHudName.textContent=d.petName||"Buddy";
  const lvl=d.petLevel||1;const xp=d.petXP||0;
  const pct=Math.max(0,Math.min(100,(xp%100)));
  petXpBar.style.width=pct+"%";
  petLevelTxt.textContent="Lv."+lvl+" • "+pct+"/100xp";
  petHud.style.display="block";
}
async function ensureUserDoc(){
  const r=doc(db,"users",currentUserId);
  const s=await getDoc(r);
  if(!s.exists()){
    await setDoc(r,{
      coins:0,
      streak:0,
      lastCheckin:"",
      pfp:"",
      journalCount:0,
      checkinCount:0,
      petXP:0,
      petLevel:1
    });
  }
}
async function loadPet(){
  if(!currentUserId)return;
  await ensureUserDoc();
  const r=doc(db,"users",currentUserId);
  const s=await getDoc(r);
  const d=s.data()||{};
  coins = d.coins || 0;
  updateCoinDisplays();
  if(d.onboardingDone){showHud(d)}
  else{
    if(!localStorage.getItem("pet.onboard")){
      step(1);
      ob.style.display="flex"
    }
  }
}
const petEmote=document.getElementById("petEmote");
let petMoodTimer=null;
function emoteShow(txt,dur=900){
  petEmote.textContent=txt;
  petEmote.style.opacity="1";
  petEmote.style.transform="translateY(0)";
  clearTimeout(petMoodTimer);
  petMoodTimer=setTimeout(()=>{
    petEmote.style.opacity="0";
    petEmote.style.transform="translateY(4px)"
  },dur);
}
function petHappy(){bloop(980,0.06);emoteShow("✨",1000)}
function petCoin(){bloop(920,0.05);emoteShow("🪙",900)}
function petCheer(){bloop(1040,0.08);emoteShow("🎉",1100)}
function petCalm(){bloop(680,0.05);emoteShow("💛",900)}
function idleTicker(){
  const r=Math.random();
  if(r<.25)emoteShow("⭐",600);
  else if(r<.5)emoteShow("💫",600);
  else if(r<.75)emoteShow("🌟",600);
  else emoteShow("✨",600);
}
setInterval(idleTicker,4200);
const petEl=document.querySelector(".pixel-pet.small");
function petMoodIdle(){if(!petEl)return;petEl.classList.remove("happy","hurt","sleep");petEl.classList.add("idle")}
function petMoodSleep(){if(!petEl)return;petEl.classList.remove("happy","hurt","idle");petEl.classList.add("sleep")}
setInterval(()=>{if(document.hidden)petMoodSleep();else petMoodIdle()},4000);
onAuthStateChanged(auth, (user) => {
  const loadingOverlay = document.getElementById("loadingOverlay");
  if (user) {
    currentUserId = user.uid;
    document.getElementById("currentUserId").value = user.uid;
    loadingOverlay.style.display = "none";
    loadPet();
  } else {
    currentUserId = "";
    document.getElementById("currentUserId").value = "";
    signInAnonymously(auth).catch((error) => {
      console.error("Anonymous sign-in failed:", error);
    });
    loadingOverlay.style.display = "flex";
  }
});
</script>
</body>
</html>