<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Unhook</title>
<link href="https://fonts.googleapis.com/css2?family=Hanken+Grotesk:wght@400;600;700&family=DM+Sans:wght@400;600;700&family=Poppins:wght@400;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;font-family:var(--app-font,"Hanken Grotesk"),system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
:root{--brand:#002293;--brand-dark:#001b75;--bg1:#f5faff;--bg2:#e3f3ff;--card:#fff;--ink:#0b1b33;--muted:#6b7a90;--ring:rgba(0,34,147,.18);--accent:#002293}
body[data-theme="ocean"]{--bg1:#e8f7ff;--bg2:#cfefff;--brand:#0066cc;--brand-dark:#004b99;--accent:#0066cc}
body[data-theme="sunset"]{--bg1:#fff2e8;--bg2:#ffe1cf;--brand:#ff7a59;--brand-dark:#d55c3e;--accent:#ff7a59}
body[data-theme="midnight"]{--bg1:#0e1220;--bg2:#0a0f1a;--card:#11162a;--ink:#dfe7ff;--muted:#9fb1ff;--brand:#5b7cff;--brand-dark:#3e5fe6;--accent:#5b7cff}
body[data-theme="sunny"]{--bg1:#fffddb;--bg2:#fff8c2;--brand:#ff9f43;--brand-dark:#d68233;--accent:#ff9f43}
body[data-theme="calm"]{--bg1:#f0fbf8;--bg2:#e3f6f1;--brand:#00a388;--brand-dark:#007f6c;--accent:#00a388}
body[data-theme="forest"]{--bg1:#f0fff0;--bg2:#e3ffe3;--brand:#4c8a4c;--brand-dark:#3a6e3a;--accent:#4c8a4c}
html,body{height:100%;margin:0;padding:0}
body{background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink)}
header{background:var(--brand);color:#fff;padding:24px;font-size:28px;font-weight:700;text-align:center}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.tabs{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:14px auto 8px;align-items:center}
.tab{background:var(--brand);color:#fff;padding:12px 22px;border-radius:999px;cursor:pointer;font-weight:600;transition:.12s}
.tab:hover{background:var(--brand-dark)}
.pill{margin-left:auto;background:#eef3ff;color:#2746ff;padding:8px 14px;border-radius:999px;font-weight:700;box-shadow:0 2px 8px var(--ring);display:flex;align-items:center;gap:8px}
.section{display:none}
.section.active{display:block;animation:fade .3s ease}
@keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:860px){.grid-2{grid-template-columns:1fr}}
.card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 24px var(--ring);margin:14px 0}
select,input,textarea{width:100%;padding:14px;border-radius:12px;border:1px solid #e7eef8;box-shadow:0 6px 14px rgba(0,0,0,.04);color:var(--ink);background:#fff}
.cta{background:var(--brand);color:#fff;border:0;padding:12px 20px;border-radius:999px;font-weight:700;cursor:pointer;box-shadow:0 10px 24px var(--ring)}
.cta:hover{background:var(--brand-dark)}
.cta.small{padding:8px 14px;font-size:14px}
.cta.ghost{background:transparent;color:var(--brand);border:2px solid var(--brand)}
.inline{display:flex;align-items:center;gap:8px}
.space-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
.muted{color:var(--muted);font-size:14px}
.pfp-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(60px,1fr));gap:10px;margin-top:8px}
.pfp-choice{font-size:32px;padding:10px;cursor:pointer;background:var(--card);border:2px solid transparent;border-radius:14px;text-align:center;transition:.2s}
.pfp-choice.active{border-color:var(--brand);transform:scale(1.12)}
.badge-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.badge{text-align:left;padding:14px;border-radius:12px;background:var(--card);box-shadow:0 2px 8px var(--ring);font-size:14px}
.chat-box{height:380px;overflow:auto;border-radius:16px;background:var(--card);padding:12px;box-shadow:inset 0 0 0 1px #e9eef6,0 10px 24px var(--ring)}
.chat-msg{margin-bottom:10px;display:flex;align-items:flex-start;gap:8px}
.chat-bubble{padding:10px 14px;border-radius:14px;max-width:80%;line-height:1.35;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.chat-me{background:#c7e6ff;border:1px solid #9fd3ff;margin-left:auto}
.chat-other{background:#fff9cc;border:1px solid #f5e6a5}
textarea#chatInput{height:70px;resize:none}
.profile-pic{width:120px;height:120px;border-radius:50%;object-fit:cover;box-shadow:0 4px 12px rgba(0,0,0,.15);margin-bottom:10px;background:#fff}
.stat-row{display:flex;justify-content:space-between;padding:4px 0;font-size:15px}
.motivation-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin-top:12px}
.sticky{padding:14px;border-radius:12px;font-size:16px;box-shadow:0 6px 14px rgba(0,0,0,.08);font-family:"Playfair Display",serif;transition:transform .2s}
.sticky:hover{transform:scale(1.03)}
.sticky.gentle.blue{background:#e8f1ff;border:1px solid #c8dcff}
.sticky.gentle.green{background:#e8fff6;border:1px solid #c6f5e3}
.sticky.gentle.teal{background:#e7fbff;border:1px solid #c6eef7}
.sticky.firey.yellow{background:#fff6cc;border:1px solid #ffec99}
.sticky.firey.red{background:#ffe1e1;border:1px solid #ffbfbf}
.sticky.firey.orange{background:#ffe8d6;border:1px solid #ffd0ad}
.sticky.mix.purple{background:#efe5ff;border:1px solid #d6c7ff}
.sticky.mix.pink{background:#ffe6f1;border:1px solid #ffcde3}
.sticky.mix.indigo{background:#e6ebff;border:1px solid #cfd7ff}
.pixel-pet-wrap{image-rendering:pixelated;transform:translateZ(0)}
.pixel-pet{image-rendering:pixelated}
.pixel-pet.small{image-rendering:pixelated;animation:petBob 2s infinite}
@keyframes petBob{0%{transform:translateY(0)}50%{transform:translateY(-2px)}100%{transform:translateY(0)}}
.pixel-pet.idle rect[fill="#ffd34e"]{fill:#ffd34e}
.pixel-pet.happy rect[fill="#ffd34e"]{fill:#ffee85}
.pixel-pet.hurt rect[fill="#ffd34e"]{fill:#ff8c8c}
.pixel-pet.sleep rect[fill="#ffd34e"]{fill:#e8d87c}
.pixel-pet.happy rect[x="5"][y="11"]{fill:#ff4081}
.pixel-pet.happy rect[x="9"][y="11"]{fill:#ff4081}
.pixel-pet.hurt rect[x="5"][y="11"]{fill:#000}
.pixel-pet.hurt rect[x="9"][y="11"]{fill:#000}
.pixel-pet.sleep rect[x="5"][y="11"]{fill:#000}
.pixel-pet.sleep rect[x="9"][y="11"]{fill:#000}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 18px;font-size:14px;border-radius:20px;opacity:0;pointer-events:none;transition:opacity .3s ease;z-index:1500;box-shadow:0 6px 16px rgba(0,0,0,.2)}
#toast.show{opacity:1}
.lds-dual-ring{display:inline-block;width:64px;height:64px}
.lds-dual-ring:after{content:" ";display:block;width:46px;height:46px;margin:1px;border-radius:50%;border:5px solid var(--accent);border-color:var(--accent) transparent var(--accent) transparent;animation:lds-dual-ring 1.2s linear infinite}
@keyframes lds-dual-ring{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
</head>
<body>
<header>Unhook: Breaking the Vape</header>
<div class="tabs wrap">
  <div class="tab" data-go="checkin">Check-In</div>
  <div class="tab" data-go="journal">Journal</div>
  <div class="tab" data-go="motivation">Motivation</div>
  <div class="tab" data-go="shop">Shop</div>
  <div class="tab" data-go="profile">Profile</div>
  <div class="tab" data-go="community">Community</div>
  <div class="pill right" id="coinPill">
    <svg class="pixel-pet small" viewBox="0 0 16 16" width="40" height="40">
      <rect width="16" height="16" fill="#2b2b2b"/>
      <rect x="5" y="2" width="6" height="6" fill="#ffd34e"/>
      <rect x="4" y="4" width="2" height="2" fill="#000"/>
      <rect x="10" y="4" width="2" height="2" fill="#000"/>
      <rect x="7" y="6" width="2" height="1" fill="#000"/>
      <rect x="3" y="8" width="10" height="5" fill="#ffd34e"/>
      <rect x="2" y="10" width="12" height="3" fill="#ffb84e"/>
      <rect x="6" y="13" width="4" height="2" fill="#654321"/>
    </svg>
    Coins: <span id="coinCount">0</span>
  </div>
</div>
<main class="wrap">
<div id="onboardOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1200;">
  <div id="onboardCard" style="width:min(520px,92vw);background:#111;color:#fff;border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.35);overflow:hidden;">
    <div style="padding:20px 20px 0;display:flex;gap:12px;align-items:center;justify-content:center;">
      <div class="pixel-pet-wrap">
        <svg class="pixel-pet" viewBox="0 0 16 16" width="120" height="120">
          <rect width="16" height="16" fill="#2b2b2b"/>
          <rect x="5" y="2" width="6" height="6" fill="#ffd34e"/>
          <rect x="4" y="4" width="2" height="2" fill="#000"/>
          <rect x="10" y="4" width="2" height="2" fill="#000"/>
          <rect x="7" y="6" width="2" height="1" fill="#000"/>
          <rect x="3" y="8" width="10" height="5" fill="#ffd34e"/>
          <rect x="2" y="10" width="12" height="3" fill="#ffb84e"/>
          <rect x="6" y="13" width="4" height="2" fill="#654321"/>
        </svg>
      </div>
    </div>
    <div id="onboardStep1" style="padding:14px 20px 0;text-align:center;">
      <h3 style="margin:0 0 6px;font-size:22px;">Welcome to Unhook 2.0</h3>
      <p style="margin:0 0 14px;opacity:.9;">Meet your pixel buddy. Level it up by staying vape-free and earning coins.</p>
      <button class="cta" id="obNext1" style="margin:10px auto 20px;display:inline-block;">Next</button>
    </div>
    <div id="onboardStep2" style="display:none;padding:0 20px 0 20px;">
      <label style="font-weight:700;display:block;margin:0 0 8px;">Name your buddy</label>
      <input id="petNameInput" type="text" placeholder="e.g., Pixel Puff" style="width:100%;padding:12px;border-radius:12px;border:1px solid #2a2f3e;background:#0d1120;color:#fff;">
      <div style="display:flex;justify-content:space-between;gap:10px;margin:16px 0 20px;">
        <button class="cta ghost" id="obBack2">Back</button>
        <button class="cta" id="obNext2">Next</button>
      </div>
    </div>
    <div id="onboardStep3" style="display:none;padding:0 20px 18px 20px;">
      <label style="font-weight:700;display:block;margin:0 0 8px;">Pick your starter vibe</label>
      <select id="starterStyle" style="width:100%;padding:12px;border-radius:12px;border:1px solid #2a2f3e;background:#0d1120;color:#fff;">
        <option value="gentle">Gentle</option>
        <option value="firey">Firey</option>
        <option value="mix" selected>Mix</option>
      </select>
      <div style="display:flex;justify-content:space-between;gap:10px;margin:16px 0 20px;">
        <button class="cta ghost" id="obBack3">Back</button>
        <button class="cta" id="obFinish">Start</button>
      </div>
    </div>
  </div>
</div>
<div id="petHud" style="position:fixed;right:14px;bottom:14px;z-index:1100;display:none;">
  <div style="background:#111;color:#fff;border-radius:14px;padding:10px 12px;box-shadow:0 12px 28px rgba(0,0,0,.35);display:flex;align-items:center;gap:10px;">
    <div style="position:relative;">
      <div id="petEmote" style="position:absolute;top:-20px;left:50%;transform:translate(-50%,4px);z-index:10;font-size:16px;line-height:1;padding:4px 8px;border-radius:8px;background:#222;color:#ffd34e;box-shadow:0 6px 14px rgba(0,0,0,.25);opacity:0;transition:opacity .18s,transform .18s">⭐</div>
      <svg class="pixel-pet small" viewBox="0 0 16 16" width="40" height="40" style="margin-right:8px;vertical-align:middle;transform-origin:50% 100%;">
        <rect width="16" height="16" fill="#2b2b2b"/>
        <rect x="5" y="2" width="6" height="6" fill="#ffd34e"/>
        <rect x="4" y="4" width="2" height="2" fill="#000"/>
        <rect x="10" y="4" width="2" height="2" fill="#000"/>
        <rect x="7" y="6" width="2" height="1" fill="#000"/>
        <rect x="3" y="8" width="10" height="5" fill="#ffd34e"/>
        <rect x="2" y="10" width="12" height="3" fill="#ffb84e"/>
        <rect x="6" y="13" width="4" height="2" fill="#654321"/>
      </svg>
    </div>
    <div>
      <div id="petHudName" style="font-weight:800;letter-spacing:.2px;">Buddy</div>
      <div style="width:140px;height:8px;background:#2a2f3e;border-radius:999px;overflow:hidden;">
        <div id="petXpBar" style="height:100%;width:0;background:linear-gradient(90deg,#ffd34e,#ff9f43)"></div>
      </div>
      <div id="petLevelTxt" style="font-size:12px;opacity:.8;margin-top:2px;">Lv.1 • 0/100xp</div>
    </div>
  </div>
</div>
<div id="authScreen" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;text-align:center;">
  <h2 style="margin-bottom:20px;">Start Your Journey</h2>
  <button id="loginGoogle" class="cta" style="margin-bottom:12px;">Sign in with Google</button>
  <button id="loginEmailBtn" class="cta" style="margin-bottom:12px;">Sign in with Email</button>
  <button id="registerEmailBtn" class="cta ghost" style="margin-bottom:18px;">Create Account</button>
  <button id="continueGuest" class="cta ghost">Continue as Guest</button>
</div>
<div id="emailAuthCard" style="display:none;max-width:380px;margin:40px auto;background:#0f121c;border-radius:16px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.4);">
  <h3 id="emailAuthTitle" style="margin-bottom:10px;">Sign In</h3>
  <input id="emailInput" type="email" placeholder="Email" style="width:100%;padding:12px;margin-bottom:12px;border-radius:10px;border:1px solid #2a2f3e;background:#0d1120;color:#fff;">
  <input id="passInput" type="password" placeholder="Password" style="width:100%;padding:12px;margin-bottom:18px;border-radius:10px;border:1px solid #2a2f3e;background:#0d1120;color:#fff;">
  <button id="emailAuthSubmit" class="cta" style="width:100%;margin-bottom:10px;">Continue</button>
  <button id="emailAuthBack" class="cta ghost" style="width:100%;">Cancel</button>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
  signInAnonymously, signOut, signInWithEmailAndPassword,
  createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { 
  getFirestore, doc, setDoc, getDoc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import {
  getDatabase, ref, onChildAdded, push, set
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyAhsjCfr7B-9vxxcA9bnLr46VcxbRMftvA",
  authDomain: "unhook-38abb.firebaseapp.com",
  databaseURL: "https://unhook-38abb-default-rtdb.firebaseio.com",
  projectId: "unhook-38abb",
  storageBucket: "unhook-38abb.firebasestorage.app",
  messagingSenderId: "182531035159",
  appId: "1:182531035159:web:47163c38ee27c2ba3b8c52",
  measurementId: "G-7GGK123MDT"
};
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);
const rtdb = getDatabase(app);
let currentUserId="";
let coins=0;
const tabsWrap=document.querySelector(".tabs.wrap");
const mainEl=document.querySelector("main.wrap");
const petHudEl=document.getElementById("petHud");
const authScreen=document.getElementById("authScreen");
const emailAuthCard=document.getElementById("emailAuthCard");
const loginGoogle=document.getElementById("loginGoogle");
const loginEmailBtn=document.getElementById("loginEmailBtn");
const registerEmailBtn=document.getElementById("registerEmailBtn");
const continueGuest=document.getElementById("continueGuest");
const emailAuthTitle=document.getElementById("emailAuthTitle");
const emailInput=document.getElementById("emailInput");
const passInput=document.getElementById("passInput");
const emailAuthSubmit=document.getElementById("emailAuthSubmit");
const emailAuthBack=document.getElementById("emailAuthBack");
let isRegisterMode=false;
function setAppVisible(on){
  if(tabsWrap)tabsWrap.style.display=on?"flex":"none";
  if(mainEl)mainEl.style.display=on?"block":"none";
  if(petHudEl)petHudEl.style.display=on?"block":"none";
  if(authScreen)authScreen.style.display=on?"none":"flex";
  if(emailAuthCard)emailAuthCard.style.display="none";
}
setAppVisible(false);
if(loginGoogle){
  loginGoogle.onclick=async()=>{
    const provider=new GoogleAuthProvider();
    await signInWithPopup(auth,provider);
  };
}
if(loginEmailBtn){
  loginEmailBtn.onclick=()=>{
    isRegisterMode=false;
    emailAuthTitle.textContent="Sign In";
    emailAuthSubmit.textContent="Sign In";
    emailAuthCard.style.display="block";
    authScreen.style.display="none";
  };
}
if(registerEmailBtn){
  registerEmailBtn.onclick=()=>{
    isRegisterMode=true;
    emailAuthTitle.textContent="Create Account";
    emailAuthSubmit.textContent="Create Account";
    emailAuthCard.style.display="block";
    authScreen.style.display="none";
  };
}
if(emailAuthBack){
  emailAuthBack.onclick=()=>{
    emailAuthCard.style.display="none";
    authScreen.style.display="flex";
  };
}
if(emailAuthSubmit){
  emailAuthSubmit.onclick=async()=>{
    const email=(emailInput.value||"").trim();
    const pass=(passInput.value||"").trim();
    if(!email||!pass)return;
    if(isRegisterMode){
      await createUserWithEmailAndPassword(auth,email,pass);
    }else{
      await signInWithEmailAndPassword(auth,email,pass);
    }
  };
}
if(continueGuest){
  continueGuest.onclick=async()=>{ await signInAnonymously(auth); };
}
const LS={get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
const COIN_KEY="coins_v2";
function updateCoinDisplays(){const a=document.getElementById("coinCount");const b=document.getElementById("shopCoins");if(a)a.textContent=String(coins);if(b)b.textContent=String(coins)}
async function ensureUserDoc(uid){const r=doc(db,"users",uid);const s=await getDoc(r);if(!s.exists())await setDoc(r,{coins:0,streak:0,lastCheckin:"",journalCount:0,checkinCount:0,petXP:0,petLevel:1,onboardingDone:false,petName:"Buddy",petStyle:"mix"})}
async function loadUserData(uid){const r=doc(db,"users",uid);const s=await getDoc(r);const data=s.data()||{};const localCoins=Number(LS.get(COIN_KEY,0))||0;const remoteCoins=Number(data.coins||0);coins=Math.max(localCoins,remoteCoins);LS.set(COIN_KEY,coins);if(remoteCoins!==coins){await updateDoc(r,{coins})}updateCoinDisplays();renderStickies();renderPfpGrid();renderStatsFromLocal()}
async function addCoins(amount){const n=Number(amount)||0;if(n===0)return;coins=Math.max(0,coins+n);LS.set(COIN_KEY,coins);updateCoinDisplays();try{await updateDoc(doc(db,"users",currentUserId),{coins})}catch{}}
function renderStatsFromLocal(){const days=LS.get("days",{});const entries=LS.get("journal_entries",[]);const cc=document.getElementById("checkinCount");const jc=document.getElementById("journalCount");if(cc)cc.textContent=Object.keys(days).length;if(jc)jc.textContent=entries.length}
onAuthStateChanged(auth,async user=>{if(user){currentUserId=user.uid;await ensureUserDoc(currentUserId);await loadUserData(currentUserId);setAppVisible(true)}else{currentUserId="";setAppVisible(false)}});
function todayKey(){return new Date().toISOString().slice(0,10)}
function setText(id,txt){const el=document.getElementById(id);if(el)el.textContent=txt}
function showToast(msg){const t=document.getElementById("toast");if(!t)return;t.textContent=msg;t.classList.add("show");clearTimeout(t._h);t._h=setTimeout(()=>t.classList.remove("show"),2000)}
function confettiBurst(){try{confetti({particleCount:120,spread:80,origin:{y:0.7}})}catch{}}
function updateStreakUI(){const s=Number(LS.get("streak",0))||0;setText("streakCount",String(s));const d=document.getElementById("streakDays");if(d)d.textContent=String(s);const lbl=document.getElementById("streakLabel");if(lbl)lbl.textContent=s===1?"day":"days"}
function incrementCounterLS(key){const v=Number(LS.get(key,0))||0;LS.set(key,v+1)}
function renderHistoryLists(){const days=LS.get("days",{});const j=LS.get("journal_entries",[]);const ul=document.getElementById("journalHistory");const card=document.getElementById("journalHistoryCard");if(ul){ul.innerHTML="";j.slice(-10).reverse().forEach(e=>{const li=document.createElement("li");li.textContent=e.prompt||"(free write)";ul.appendChild(li)});if(card)card.style.display=j.length?"block":"none"}}
function bindTabs(){document.querySelectorAll(".tab").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));t.classList.add("active");document.getElementById(t.dataset.go).classList.add("active");if(t.dataset.go==="motivation"){renderStickies()}if(t.dataset.go==="profile"){renderPfpGrid();updateStreakUI();renderStatsFromLocal()}if(t.dataset.go==="journal"){renderHistoryLists()}}))}
bindTabs()
function bindCheckin(){const btn=document.getElementById("saveCheckinBtn");if(!btn)return;btn.addEventListener("click",async()=>{const day=todayKey();const days=LS.get("days",{});if(days[day]){setText("checkinMsg","You already checked in today.");showToast("Already saved today");return}const data={mood:Number((document.getElementById("moodSel")||{}).value||0),cravings:(document.getElementById("craveSel")||{}).value||"none",trigger:(document.getElementById("triggerTxt")||{}).value?.trim()||"",vaped:(document.getElementById("vapedSel")||{}).value||"no",notes:(document.getElementById("notesTxt")||{}).value?.trim()||"",ts:Date.now()};days[day]=data;LS.set("days",days);const y=new Date();y.setDate(y.getDate()-1);const hadYesterday=Boolean(days[y.toISOString().slice(0,10)]);let streak=Number(LS.get("streak",0))||0;streak=hadYesterday?Math.max(1,streak)+1:1;LS.set("streak",streak);updateStreakUI();let earned=5;if(data.vaped==="no")earned+=10;if(data.cravings==="none")earned+=5;await addCoins(earned);incrementCounterLS("checkinCount");renderStatsFromLocal();setText("checkinMsg",`Saved! You earned +${earned} coins.`);showToast(`+${earned} coins`);confettiBurst();setTimeout(()=>setText("checkinMsg",""),2200)})}
bindCheckin()
let promptIndex=0
function bindJournal(){const prev=document.getElementById("prevPrompt");const next=document.getElementById("nextPrompt");const save=document.getElementById("saveJournalBtn");const text=document.getElementById("promptText");const FREE=()=>document.getElementById("freeWriteToggle")?.checked||false;const PROMPTS=(window.PROMPTS&&Array.isArray(window.PROMPTS)&&window.PROMPTS.length)?window.PROMPTS:[];function show(){if(text)text.textContent=PROMPTS.length?PROMPTS[promptIndex]:""}if(prev)prev.addEventListener("click",()=>{if(!PROMPTS.length)return;promptIndex=(promptIndex-1+PROMPTS.length)%PROMPTS.length;show()});if(next)next.addEventListener("click",()=>{if(!PROMPTS.length)return;promptIndex=(promptIndex+1)%PROMPTS.length;show()});if(save)save.addEventListener("click",async()=>{const box=document.getElementById("journalEntry");const val=(box?.value||"").trim();if(!val){const m=document.getElementById("saveJournalMsg");if(m)m.textContent="Write something first";showToast("Write something first");return}const entries=LS.get("journal_entries",[]);entries.push({prompt:FREE()?null:(PROMPTS[promptIndex]||null),entry:val,ts:Date.now()});LS.set("journal_entries",entries);if(box)box.value="";const m=document.getElementById("saveJournalMsg");if(m)m.textContent="Saved! +7 coins";await addCoins(7);renderHistoryLists();renderStatsFromLocal();showToast("+7 coins");setTimeout(()=>{if(m)m.textContent=""},1600)}) ;show()}
bindJournal()
document.addEventListener("DOMContentLoaded",()=>{updateCoinDisplays();updateStreakUI();renderStatsFromLocal();renderHistoryLists();renderStickies();renderPfpGrid()})
const G_BASE=["You are safe right now.","Breathe in and out slowly.","Let the urge float by.","Your body is healing.","Tiny steps add up.","Choose gentleness today.","You can pause and reset.","Your calm is growing.","One kind thought at a time.","You’re doing enough."];
const F_BASE=["Own this moment.","Choose the hard right.","You’re stronger than the urge.","Control the minute.","Say no and stand tall.","Push through the dip.","Prove it to yourself.","Attack the habit loop.","Dominate the next 5 mins.","Refuse the shortcut."];
const M_BASE=["Reset with one choice.","Progress over perfection.","Stack small wins.","Future you is cheering.","Keep the streak alive.","Every check-in counts.","Breath, water, move.","This is who you are now.","Celebrate tiny victories.","You’re getting sharper."];
function buildHundred(base){const out=[];for(let i=0;i<100;i++){out.push(base[i%base.length])}return out}
const STK100={
  gentle:buildHundred(G_BASE),
  firey:buildHundred(F_BASE),
  mix:buildHundred(M_BASE)
}
const PALETTES={
  gentle:[{bg:"#e6f3ff",bd:"#bfe1ff"},{bg:"#e7fff4",bd:"#bff7e2"},{bg:"#e6fbff",bd:"#bdefff"}],
  firey:[{bg:"#fff3c4",bd:"#ffe49a"},{bg:"#ffd7d7",bd:"#ffbebe"},{bg:"#ffe1c7",bd:"#ffcfac"}],
  mix:[{bg:"#f2e6ff",bd:"#e1c8ff"},{bg:"#ffe1f3",bd:"#ffc7e7"},{bg:"#e6ebff",bd:"#c9d3ff"}]
}
function renderStickiesV2(){
  const gridA=document.getElementById("motivationGrid")
  const gridB=document.getElementById("stickyGrid")
  const grid=gridA||gridB
  if(!grid)return
  const saved=(localStorage.getItem("motivation_style")||'"mix"').replace(/^"+|"+$/g,"")
  const style=document.getElementById("motivationStyle")?document.getElementById("motivationStyle").value:saved
  const list=STK100[style]||STK100.mix
  const pal=PALETTES[style]||PALETTES.mix
  grid.innerHTML=""
  for(let i=0;i<list.length;i++){
    const p=pal[i%pal.length]
    const d=document.createElement("div")
    d.className="sticky"
    d.textContent=list[i]
    d.style.background=p.bg
    d.style.border="1px solid "+p.bd
    grid.appendChild(d)
  }
  const c=document.getElementById("motivationCount")
  if(c)c.textContent=list.length+" stickies found"
}
window.renderStickies=renderStickiesV2
document.getElementById("motivationStyle")?.addEventListener("change",()=>{renderStickiesV2()})
document.getElementById("saveStyleBtn")?.addEventListener("click",()=>{
  const style=document.getElementById("motivationStyle").value
  localStorage.setItem("motivation_style",JSON.stringify(style))
  renderStickiesV2()
  showToast("Style saved!")
})
async function saveCheckin(){
  const mood=document.getElementById("moodSel").value
  const crave=document.getElementById("craveSel").value
  const trig=document.getElementById("triggerTxt").value
  const vaped=document.getElementById("vapedSel").value
  const notes=document.getElementById("notesTxt").value
  const t=Date.now()
  const entry={mood,crave,trigger:trig,vaped,notes,time:t}
  const uid=currentUserId||"anon"
  await addDoc(collection(db,"users",uid,"checkins"),entry)
  let i=JSON.parse(localStorage.getItem("history_check")||"[]")
  i.unshift(entry)
  localStorage.setItem("history_check",JSON.stringify(i.slice(0,30)))
  addCoins(5)
  updateStreak(1)
  showToast("Check-in saved! +5 🪙")
}
document.getElementById("saveCheckinBtn")?.addEventListener("click",saveCheckin)
async function saveJournal(){
  const txt=document.getElementById("journalEntry").value.trim()
  if(!txt)return showToast("Write something first")
  const t=Date.now()
  const uid=currentUserId||"anon"
  const obj={text:txt,time:t}
  await addDoc(collection(db,"users",uid,"journal"),obj)
  let j=JSON.parse(localStorage.getItem("history_journal")||"[]")
  j.unshift(obj)
  localStorage.setItem("history_journal",JSON.stringify(j.slice(0,30)))
  document.getElementById("journalEntry").value=""
  addCoins(7)
  updateStreak(1)
  showToast("Entry saved! +7 🪙")
}
document.getElementById("saveJournalBtn")?.addEventListener("click",saveJournal)
onAuthStateChanged(auth, (user) => {
  const loadingOverlay = document.getElementById("loadingOverlay");
  if (user) {
    currentUserId = user.uid;
    document.getElementById("currentUserId").value = user.uid;
    loadingOverlay.style.display = "none";
    loadPet();
  } else {
    currentUserId = "";
    document.getElementById("currentUserId").value = "";
    signInAnonymously(auth).catch((error) => {
      console.error("Anonymous sign-in failed:", error);
    });
    loadingOverlay.style.display = "flex";
  }
});
function findBtn(regex){
  return [...document.querySelectorAll("button")].find(b=>regex.test((b.textContent||"").trim()))
}
const btnGoogle=findBtn(/sign in with google/i)
const btnEmail=findBtn(/sign in with email/i)
const btnCreate=findBtn(/create account/i)
const btnGuest=findBtn(/continue as guest/i)
const provider=new GoogleAuthProvider()

btnGoogle?.addEventListener("click",async()=>{
  try{
    await signInWithPopup(auth,provider)
    showToast("Signed in with Google")
  }catch(e){showToast("Google sign-in failed")}
})

btnEmail?.addEventListener("click",async()=>{
  const email=prompt("Email")
  if(!email)return
  const pass=prompt("Password")
  if(!pass)return
  try{
    await signInWithEmailAndPassword(auth,email,pass)
    showToast("Signed in")
  }catch(e){showToast("Email sign-in failed")}
})
btnCreate?.addEventListener("click",async()=>{
  const email=prompt("New account email")
  if(!email)return
  const pass=prompt("New account password (6+ chars)")
  if(!pass)return
  try{
    await createUserWithEmailAndPassword(auth,email,pass)
    showToast("Account created")
  }catch(e){showToast("Sign up failed")}
})

btnGuest?.addEventListener("click",async()=>{
  try{
    await signInAnonymously(auth)
    showToast("Continuing as guest")
  }catch(e){showToast("Guest sign-in failed")}
})