<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Unhook</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 560px; margin: 24px auto; padding: 0 12px;}
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0;}
    button { padding: 10px 14px; border-radius: 8px; border: 0; }
    .row { display: flex; gap: 8px; align-items: center; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>Unhook</h1>
  <div id="auth" class="card">
    <button id="anon">Continue Anonymously</button>
    <div class="row">
      <input id="email" placeholder="email"/>
      <input id="pass" type="password" placeholder="password"/>
      <button id="emailBtn">Sign in</button>
    </div>
    <div id="me"></div>
  </div>

  <div id="checkin" class="card" style="display:none">
    <h3>Daily check-in</h3>
    <label>Vaped today?
      <select id="vaped"><option value="">(skip)</option><option value="no">No</option><option value="yes">Yes</option></select>
    </label><br/><br/>
    <label>Cravings (0–3): <input id="cravings" type="number" min="0" max="3" value="0"/></label><br/><br/>
    <label>Mood (1–5): <input id="mood" type="number" min="1" max="5" value="3"/></label><br/><br/>
    <textarea id="journal" placeholder="journal (optional)" rows="4" style="width:100%"></textarea><br/>
    <label><input type="checkbox" class="ex" value="breathing"/> deep breathing</label>
    <label><input type="checkbox" class="ex" value="walk"/> short walk</label>
    <br/><br/>
    <button id="submit">Submit</button>
    <pre id="result"></pre>
  </div>

  <div id="buddy" class="card" style="display:none">
    <h3>Your buddy: <span id="buddyType">bunny</span> (<span id="buddyMood">ok</span>)</h3>
    <div>Coins: <span id="coins">0</span> | Streak: <span id="streak">0</span></div>
    <button id="buyCarrot">Buy Carrot (5)</button>
  </div>

<script>
  // ---- 1) Firebase init (paste your config!) ----
  const firebaseConfig = {
    apiKey: "PASTE",
    authDomain: "PASTE",
    projectId: "PASTE",
    appId: "PASTE"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // ---- 2) buttons ----
  anon.onclick = () => auth.signInAnonymously();
  emailBtn.onclick = async () => {
    try { await auth.signInWithEmailAndPassword(email.value, pass.value); }
    catch(e){ await auth.createUserWithEmailAndPassword(email.value, pass.value); }
  };

  // ---- 3) on login, show UI ----
  auth.onAuthStateChanged(async (user) => {
    if (!user) return;
    me.textContent = `Signed in as ${user.uid}`;
    document.getElementById('checkin').style.display = 'block';
    document.getElementById('buddy').style.display = 'block';
    refreshBuddy();
  });

  async function callAPI(path, body){
    const token = await auth.currentUser.getIdToken();
    const res = await fetch(`http://localhost:8000${path}`, {
      method: "POST",
      headers: { "Content-Type":"application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify(body)
    });
    if(!res.ok){ throw new Error(await res.text()); }
    return await res.json();
  }

  submit.onclick = async () => {
    const v = document.getElementById("vaped").value;
    const body = {
      vaped: (v==""? null : (v==="yes")),
      cravings: Number(cravings.value),
      mood: Number(mood.value),
      journal: journal.value,
      doneExercises: Array.from(document.querySelectorAll(".ex:checked")).map(x=>x.value)
    };
    const out = await callAPI("/api/checkin", body);
    result.textContent = JSON.stringify(out, null, 2);
    await refreshBuddy();
  };

  async function refreshBuddy(){
    const uid = auth.currentUser.uid;
    const u = await db.collection('users').doc(uid).get();
    if(u.exists){
      const d = u.data();
      buddyType.textContent = d.buddy?.type || "bunny";
      buddyMood.textContent = d.buddy?.mood || "ok";
      coins.textContent = d.coins ?? 0;
      streak.textContent = d.streak ?? 0;
    }
  }

  buyCarrot.onclick = async ()=>{
    await callAPI("/api/purchase", {itemId:"carrot", price:5});
    await refreshBuddy();
  };
</script>
</body>
</html>